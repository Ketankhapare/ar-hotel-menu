<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Markerless AR Menu</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- WebXR Hit Test -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    .hint {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      z-index: 10;
    }
  </style>
</head>

<body>

<div class="hint">Tap on floor/table to place dish</div>

<a-scene
  renderer="antialias: true; alpha: true"
  vr-mode-ui="enabled: false"
  embedded
  xr-mode-ui="enabled: true"
  webxr="optionalFeatures: hit-test;">

  <!-- Camera -->
  <a-camera></a-camera>

  <!-- Reticle (Placement Cursor) -->
  <a-entity
    id="reticle"
    geometry="primitive: ring; radiusInner: 0.03; radiusOuter: 0.04"
    material="color: yellow; shader: flat"
    rotation="-90 0 0"
    visible="false">
  </a-entity>

  <!-- Dish -->
  <a-gltf-model
    id="dish"
    src="assets/fooddish.glb"
    visible="false"
    scale="0.3 0.3 0.3">
  </a-gltf-model>

  <!-- Light -->
  <a-entity light="type: ambient; intensity: 1"></a-entity>
  <a-entity light="type: directional; intensity: 1" position="1 3 2"></a-entity>

</a-scene>

<script>
  const scene = document.querySelector("a-scene");
  const reticle = document.getElementById("reticle");
  const dish = document.getElementById("dish");

  let hitTestSource = null;
  let hitTestSourceRequested = false;
  let placed = false;
  let lastX = null;

  scene.addEventListener("enter-vr", async () => {
    const session = scene.renderer.xr.getSession();

    session.addEventListener("select", () => {
      if (!reticle.object3D.visible || placed) return;

      dish.object3D.position.copy(reticle.object3D.position);
      dish.setAttribute("visible", "true");
      placed = true;
      document.querySelector(".hint").innerText = "Drag to rotate dish";
    });

    const viewerSpace = await session.requestReferenceSpace("viewer");
    hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
    const localSpace = await session.requestReferenceSpace("local");

    scene.renderer.xr.setReferenceSpace(localSpace);

    scene.renderer.setAnimationLoop((timestamp, frame) => {
      if (!frame) return;

      const hitTestResults = frame.getHitTestResults(hitTestSource);
      if (hitTestResults.length > 0 && !placed) {
        const pose = hitTestResults[0].getPose(localSpace);
        reticle.object3D.visible = true;
        reticle.object3D.position.set(
          pose.transform.position.x,
          pose.transform.position.y,
          pose.transform.position.z
        );
      }
    });
  });

  // Touch rotation
  window.addEventListener("touchstart", e => {
    if (!placed) return;
    lastX = e.touches[0].clientX;
  });

  window.addEventListener("touchmove", e => {
    if (!placed || lastX === null) return;
    const deltaX = e.touches[0].clientX - lastX;
    lastX = e.touches[0].clientX;
    dish.object3D.rotation.y += deltaX * 0.01;
  });

  window.addEventListener("touchend", () => lastX = null);
</script>

</body>
</html>
